<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngaliyan Hebat - Sistem Pengaduan Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hidden-section { display: none !important; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Custom Scrollbar agar lebih cantik */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900">

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div id="auth-container" class="w-full max-w-md transition-all duration-500">
            <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden">
                <div class="bg-gradient-to-br from-blue-800 to-emerald-700 p-8 text-white text-center">
                    <div class="flex justify-center mb-4"><i data-lucide="building-2" class="w-10 h-10"></i></div>
                    <h1 class="text-2xl font-black tracking-tight">Ngaliyan Hebat</h1>
                </div>

                <div class="p-8 md:p-10">
                    <div id="auth-error" class="hidden-section mb-6 p-4 bg-rose-50 text-rose-600 rounded-2xl text-xs font-bold flex items-center gap-2 border border-rose-100">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> <span id="error-msg"></span>
                    </div>

                    <form id="login-form" class="space-y-5">
                        <input type="text" id="l-user" placeholder="Username" required class="w-full bg-slate-50 border-2 border-transparent rounded-2xl py-4 px-6 outline-none focus:border-blue-100 transition-all font-semibold">
                        <input type="password" id="l-pass" placeholder="Password" required class="w-full bg-slate-50 border-2 border-transparent rounded-2xl py-4 px-6 outline-none focus:border-blue-100 transition-all font-semibold">
                        <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-2xl shadow-xl shadow-blue-100 transition-all uppercase text-xs tracking-widest">Masuk</button>
                        <p class="text-center text-xs font-bold text-slate-400 mt-6">Belum punya akun? <span class="text-emerald-600 cursor-pointer hover:underline" onclick="toggleAuth(true)">Daftar Sekarang</span></p>
                    </form>

                    <form id="register-form" class="hidden-section space-y-4">
                        <input type="text" id="r-name" placeholder="Nama Lengkap" required class="w-full bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="r-user" placeholder="Username" required class="bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold border border-transparent focus:border-emerald-200">
                            <input type="password" id="r-pass" placeholder="Password" required class="bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold border border-transparent focus:border-emerald-200">
                        </div>
                        <textarea id="r-addr" placeholder="Alamat Sesuai KTP" required class="w-full bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold h-20"></textarea>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl uppercase text-xs tracking-widest shadow-lg shadow-emerald-100">Registrasi</button>
                        <button type="button" onclick="toggleAuth(false)" class="w-full text-xs font-bold text-slate-400 font-sans">Batal</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden-section min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-72 bg-white border-r border-slate-100 p-8 flex flex-col h-screen sticky top-0">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-10 h-10 bg-blue-700 rounded-xl flex items-center justify-center text-white"><i data-lucide="megaphone" class="w-5 h-5"></i></div>
                <h2 class="font-black text-slate-900 leading-tight">Sistem<br/><span class="text-emerald-600">Lapor</span></h2>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="changeTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all bg-blue-50 text-blue-700">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="changeTab('new')" id="nav-new" class="nav-btn w-full hidden flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all text-slate-400 hover:bg-slate-50">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Lapor Baru
                </button>
                <button onclick="changeTab('riwayat')" id="nav-riwayat" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all text-slate-400 hover:bg-slate-50">
                    <i data-lucide="history" class="w-5 h-5"></i> Riwayat Laporan
                </button>
            </nav>
            <div class="mt-auto pt-8 border-t">
                <div class="bg-slate-50 p-4 rounded-2xl mb-4">
                    <p id="user-fullname" class="text-sm font-black text-slate-800 truncate"></p>
                    <p id="user-role-label" class="text-[9px] font-bold text-blue-600 uppercase"></p>
                </div>
                <button onclick="location.reload()" class="w-full flex items-center justify-center gap-2 text-rose-500 font-bold text-xs py-3 rounded-xl hover:bg-rose-50 transition-all uppercase tracking-widest"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
            </div>
        </aside>

        <main class="flex-1 p-6 md:p-12 overflow-auto bg-[#F8FAFC]">
            <div id="tab-dashboard" class="tab-content h-full">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full max-w-7xl mx-auto">
                    <div class="lg:col-span-4 space-y-4">
                        <h3 class="font-black text-slate-900 text-2xl mb-6">Laporan Masuk</h3>
                        <div id="complaint-list" class="space-y-4"></div>
                    </div>
                    <div id="detail-panel" class="lg:col-span-8 bg-white rounded-[2.5rem] shadow-sm flex flex-col border border-slate-100 overflow-hidden min-h-[600px]">
                        <div id="no-selection" class="flex-1 flex flex-col items-center justify-center text-slate-300">
                            <i data-lucide="message-square" class="w-16 h-16 opacity-10 mb-4"></i>
                            <p class="font-black uppercase tracking-widest text-[10px]">Pilih laporan untuk diskusi</p>
                        </div>
                        <div id="chat-ui" class="hidden-section flex flex-col h-full">
                            <div id="chat-header" class="p-8 border-b bg-white flex justify-between items-center"></div>
                            <div id="chat-messages" class="flex-1 p-8 overflow-y-auto space-y-6 bg-slate-50/30"></div>
                            <div class="p-6 border-t bg-white flex gap-3">
                                <input type="text" id="chat-input" placeholder="Tulis balasan..." class="flex-1 bg-slate-50 p-4 rounded-xl outline-none text-sm font-bold">
                                <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 rounded-xl hover:bg-blue-700 transition-all"><i data-lucide="send" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-new" class="tab-content hidden-section max-w-2xl mx-auto">
                <h3 class="text-3xl font-black text-slate-900 mb-8">Buat Pengaduan</h3>
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
                    <form id="new-complaint-form" class="space-y-6">
                        <input type="text" id="c-title" required placeholder="Judul Pengaduan" class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="c-phone" required placeholder="Nomor Telepon / WA" class="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold">
                            <input type="text" id="c-loc" required placeholder="Alamat Kejadian" class="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold">
                        </div>
                        <textarea id="c-desc" required placeholder="Jelaskan detail masalah..." class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold h-32"></textarea>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lampiran Foto (Maks 5)</label>
                                <span id="img-counter" class="text-[10px] font-bold text-blue-500">0/5</span>
                            </div>
                            <div id="preview-container" class="flex flex-wrap gap-2">
                                <label class="w-16 h-16 rounded-lg bg-slate-50 border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer text-slate-400">
                                    <i data-lucide="camera" class="w-5 h-5"></i>
                                    <input type="file" id="c-files" multiple accept="image/*" class="hidden" onchange="handleFiles(this)">
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-700 text-white font-black py-5 rounded-2xl uppercase text-xs tracking-widest shadow-xl">Kirim Laporan</button>
                    </form>
                </div>
            </div>

            <div id="tab-riwayat" class="tab-content hidden-section max-w-7xl mx-auto">
                <h3 class="text-3xl font-black text-slate-900 mb-10">Riwayat Pengaduan</h3>
                <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </main>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: '123', fullName: 'Admin Ngaliyan', role: 'admin' },
            { username: 'warga', password: '123', fullName: 'Budi Santoso', role: 'warga' }
        ];
        let complaints = JSON.parse(localStorage.getItem('complaints')) || [];
        let currentUser = null;
        let currentChatId = null;
        let currentImages = [];

        // Auth Logic
        function toggleAuth(isReg) {
            document.getElementById('login-form').classList.toggle('hidden-section', isReg);
            document.getElementById('register-form').classList.toggle('hidden-section', !isReg);
            document.getElementById('auth-error').classList.add('hidden-section');
        }

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;
            const user = users.find(user => user.username === u && user.password === p);
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden-section');
                document.getElementById('main-app').classList.remove('hidden-section');
                document.getElementById('user-fullname').innerText = currentUser.fullName;
                document.getElementById('user-role-label').innerText = currentUser.role;
                if (currentUser.role === 'warga') document.getElementById('nav-new').classList.remove('hidden');
                renderComplaintList();
                lucide.createIcons();
            } else {
                document.getElementById('auth-error').classList.remove('hidden-section');
                document.getElementById('error-msg').innerText = "Login Gagal!";
            }
        };

        document.getElementById('register-form').onsubmit = (e) => {
            e.preventDefault();
            users.push({
                username: document.getElementById('r-user').value,
                password: document.getElementById('r-pass').value,
                fullName: document.getElementById('r-name').value,
                role: 'warga'
            });
            localStorage.setItem('users', JSON.stringify(users));
            alert('Berhasil! Silakan Login.');
            toggleAuth(false);
        };

        // Navigation
        function changeTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
            document.getElementById('tab-' + tab).classList.remove('hidden-section');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-50', 'text-blue-700');
                b.classList.add('text-slate-400');
            });
            document.getElementById('nav-' + tab).classList.add('bg-blue-50', 'text-blue-700');
            if (tab === 'riwayat') renderHistory();
            if (tab === 'dashboard') renderComplaintList();
            lucide.createIcons();
        }

        // Complaint & History Logic
        function renderComplaintList() {
            const list = document.getElementById('complaint-list');
            const data = currentUser.role === 'admin' ? complaints : complaints.filter(c => c.username === currentUser.username);
            list.innerHTML = data.map(c => `
                <div onclick="openDetail(${c.id})" class="p-6 rounded-[2rem] bg-white border border-slate-100 hover:border-blue-200 cursor-pointer shadow-sm transition-all">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px] font-black px-2 py-1 bg-blue-50 text-blue-700 rounded-lg uppercase">${c.status}</span>
                        <span class="text-[10px] text-slate-300 font-bold">${c.date}</span>
                    </div>
                    <h4 class="font-bold text-slate-800">${c.title}</h4>
                    <p class="text-[10px] text-slate-400 mt-2 font-bold uppercase"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${c.location}</p>
                </div>
            `).join('') || '<p class="text-center py-10 text-slate-400">Belum ada data</p>';
            lucide.createIcons();
        }

        function renderHistory() {
            const grid = document.getElementById('history-grid');
            const data = currentUser.role === 'admin' ? complaints : complaints.filter(c => c.username === currentUser.username);
            grid.innerHTML = data.map(c => `
                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm relative overflow-hidden group">
                    <div class="flex gap-2 mb-4">${c.images.map(img => `<img src="${img}" class="w-12 h-12 rounded-lg object-cover border">`).join('')}</div>
                    <h4 class="font-black text-xl text-slate-800 mb-2">${c.title}</h4>
                    <p class="text-xs text-slate-400 font-bold mb-6 italic leading-relaxed">"${c.description}"</p>
                    <div class="grid grid-cols-2 gap-2 text-[10px] font-black text-slate-500 uppercase tracking-widest mb-6">
                        <span><i data-lucide="phone" class="w-3 h-3 inline"></i> ${c.phone}</span>
                        <span><i data-lucide="calendar" class="w-3 h-3 inline"></i> ${c.date}</span>
                    </div>
                    <button onclick="openLiveChat(${c.id})" class="w-full flex items-center justify-center gap-2 py-4 bg-emerald-600 text-white rounded-2xl text-xs font-black uppercase hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> Buka Live Chat
                    </button>
                </div>
            `).join('') || '<p class="text-center col-span-2 py-20 text-slate-300 font-black uppercase tracking-widest">Kosong</p>';
            lucide.createIcons();
        }

        // Live Chat Logic
        function openLiveChat(id) { changeTab('dashboard'); openDetail(id); }

        function openDetail(id) {
            currentChatId = id;
            const comp = complaints.find(c => c.id === id);
            document.getElementById('no-selection').classList.add('hidden-section');
            document.getElementById('chat-ui').classList.remove('hidden-section');
            document.getElementById('chat-header').innerHTML = `
                <div>
                    <h4 class="font-black text-slate-900 text-xl">${comp.title}</h4>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status: ${comp.status} | Lokasi: ${comp.location}</p>
                </div>
                ${currentUser.role === 'admin' ? `<button onclick="closeTicket(${id})" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Selesaikan</button>` : ''}
            `;
            renderMessages();
        }

        function renderMessages() {
            const comp = complaints.find(c => c.id === currentChatId);
            const box = document.getElementById('chat-messages');
            box.innerHTML = comp.chats.map(m => `
                <div class="flex ${m.user === currentUser.username ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] p-4 rounded-2xl text-sm font-bold shadow-sm ${m.user === currentUser.username ? 'bg-slate-900 text-white' : 'bg-white text-slate-700 border border-slate-100'}">
                        <p class="text-[9px] opacity-40 uppercase mb-1">${m.sender}</p>
                        ${m.text}
                    </div>
                </div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if(!input.value.trim()) return;
            const comp = complaints.find(c => c.id === currentChatId);
            comp.chats.push({ user: currentUser.username, sender: currentUser.fullName, text: input.value });
            localStorage.setItem('complaints', JSON.stringify(complaints));
            input.value = ''; renderMessages();
        }

        function closeTicket(id) {
            complaints.find(c => c.id === id).status = 'Selesai';
            localStorage.setItem('complaints', JSON.stringify(complaints));
            openDetail(id);
        }

        // File Upload Logic
        function handleFiles(input) {
            const files = Array.from(input.files);
            if(currentImages.length + files.length > 5) return alert("Maks 5 foto!");
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => { currentImages.push(e.target.result); renderPreviews(); };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const cont = document.getElementById('preview-container');
            document.getElementById('img-counter').innerText = `${currentImages.length}/5`;
            cont.querySelectorAll('.p-item').forEach(e => e.remove());
            currentImages.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = "p-item w-16 h-16 rounded-lg relative overflow-hidden border";
                d.innerHTML = `<img src="${img}" class="w-full h-full object-cover"><button onclick="removeImg(${i})" class="absolute top-0 right-0 bg-rose-500 text-white p-0.5 rounded-bl-lg text-[10px]">Ã—</button>`;
                cont.appendChild(d);
            });
        }
        function removeImg(i) { currentImages.splice(i,1); renderPreviews(); }

        document.getElementById('new-complaint-form').onsubmit = (e) => {
            e.preventDefault();
            complaints.unshift({
                id: Date.now(),
                username: currentUser.username,
                fullName: currentUser.fullName,
                title: document.getElementById('c-title').value,
                phone: document.getElementById('c-phone').value,
                location: document.getElementById('c-loc').value,
                description: document.getElementById('c-desc').value,
                status: 'Diterima',
                date: new Date().toLocaleDateString('id-ID'),
                images: [...currentImages],
                chats: []
            });
            localStorage.setItem('complaints', JSON.stringify(complaints));
            currentImages = []; e.target.reset(); renderPreviews();
            alert('Laporan Terkirim!'); changeTab('dashboard');
        };

        lucide.createIcons();
    </script>
</body>
</html>