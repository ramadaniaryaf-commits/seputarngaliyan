<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngaliyan Hebat - Sistem Pengaduan Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hidden-section { display: none !important; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900">

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div id="auth-container" class="w-full max-w-md transition-all duration-500">
            <div class="bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden">
                <div id="auth-header" class="bg-gradient-to-br from-blue-800 to-emerald-700 p-8 text-white text-center transition-all">
                    <div class="flex justify-center mb-4"><i data-lucide="building-2" class="w-10 h-10"></i></div>
                    <h1 id="auth-title" class="text-2xl font-black tracking-tight">Ngaliyan Hebat</h1>
                    <p id="auth-subtitle" class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-70 mt-2">Portal Pengaduan Warga</p>
                </div>

                <div class="p-8 md:p-10">
                    <div id="auth-error" class="hidden-section mb-6 p-4 bg-rose-50 text-rose-600 rounded-2xl text-xs font-bold flex items-center gap-2 border border-rose-100">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> <span id="error-msg"></span>
                    </div>

                    <form id="login-form" class="space-y-5">
                        <input type="text" id="l-user" placeholder="Username Warga" required class="w-full bg-slate-50 border-2 border-transparent rounded-2xl py-4 px-6 outline-none focus:border-blue-100 transition-all font-semibold">
                        <input type="password" id="l-pass" placeholder="Password" required class="w-full bg-slate-50 border-2 border-transparent rounded-2xl py-4 px-6 outline-none focus:border-blue-100 transition-all font-semibold">
                        <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-2xl shadow-xl shadow-blue-100 uppercase text-xs tracking-widest transition-all">Masuk sebagai Warga</button>
                        <div class="flex flex-col gap-3 mt-6">
                            <p class="text-center text-xs font-bold text-slate-400">Belum punya akun? <span class="text-emerald-600 cursor-pointer hover:underline" onclick="showForm('register')">Daftar Sekarang</span></p>
                            <div class="h-[1px] bg-slate-100 w-full my-2"></div>
                            <button type="button" onclick="showForm('admin')" class="text-center text-xs font-black text-blue-800 uppercase tracking-widest hover:text-blue-600">Login sebagai Admin <i data-lucide="chevron-right" class="w-3 h-3 inline"></i></button>
                        </div>
                    </form>

                    <form id="admin-form" class="hidden-section space-y-5">
                        <div class="p-3 bg-amber-50 rounded-xl border border-amber-100 text-[10px] text-amber-700 font-bold uppercase mb-4 text-center">Akses Terbatas Administrator</div>
                        <input type="text" id="admin-user" placeholder="ID Admin" required class="w-full bg-slate-900 text-white rounded-2xl py-4 px-6 outline-none border-2 border-transparent focus:border-blue-500 font-semibold">
                        <input type="password" id="admin-pass" placeholder="Password Admin" required class="w-full bg-slate-900 text-white rounded-2xl py-4 px-6 outline-none border-2 border-transparent focus:border-blue-500 font-semibold">
                        <button type="submit" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-4 rounded-2xl shadow-xl uppercase text-xs tracking-widest">Verifikasi Admin</button>
                        <button type="button" onclick="showForm('login')" class="w-full text-center text-xs font-bold text-slate-400 mt-4">Kembali ke Login Warga</button>
                    </form>

                    <form id="register-form" class="hidden-section space-y-4">
                        <input type="text" id="r-name" placeholder="Nama Lengkap" required class="w-full bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="r-user" placeholder="Username" required class="bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold">
                            <input type="password" id="r-pass" placeholder="Password" required class="bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold">
                        </div>
                        <textarea id="r-addr" placeholder="Alamat Domisili" required class="w-full bg-slate-50 p-4 rounded-xl outline-none text-sm font-semibold h-20"></textarea>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg uppercase text-xs tracking-widest">Buat Akun Warga</button>
                        <button type="button" onclick="showForm('login')" class="w-full text-xs font-bold text-slate-400 font-sans">Sudah punya akun? Masuk</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden-section min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-72 bg-white border-r border-slate-100 p-8 flex flex-col h-screen sticky top-0">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-10 h-10 bg-blue-700 rounded-xl flex items-center justify-center text-white"><i data-lucide="megaphone" class="w-5 h-5"></i></div>
                <h2 class="font-black text-slate-900 leading-tight">Sistem<br/><span class="text-emerald-600">Lapor</span></h2>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="changeTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all bg-blue-50 text-blue-700">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="changeTab('new')" id="nav-new" class="nav-btn w-full hidden flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all text-slate-400 hover:bg-slate-50">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Lapor Baru
                </button>
                <button onclick="changeTab('riwayat')" id="nav-riwayat" class="nav-btn w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-sm transition-all text-slate-400 hover:bg-slate-50">
                    <i data-lucide="history" class="w-5 h-5"></i> Riwayat Laporan
                </button>
            </nav>
            <div class="mt-auto pt-8 border-t">
                <div class="bg-slate-50 p-4 rounded-2xl mb-4">
                    <p id="user-fullname" class="text-sm font-black text-slate-800 truncate"></p>
                    <p id="user-role-label" class="text-[9px] font-bold text-blue-600 uppercase"></p>
                </div>
                <button onclick="location.reload()" class="w-full flex items-center justify-center gap-2 text-rose-500 font-bold text-xs py-3 rounded-xl hover:bg-rose-50 transition-all uppercase tracking-widest"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
            </div>
        </aside>

        <main class="flex-1 p-6 md:p-12 overflow-auto bg-[#F8FAFC]">
            <div id="tab-dashboard" class="tab-content h-full">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                    <div class="lg:col-span-4 space-y-4">
                        <h3 class="font-black text-slate-900 text-2xl mb-6">Daftar Antrean</h3>
                        <div id="complaint-list" class="space-y-4"></div>
                    </div>
                    <div id="detail-panel" class="lg:col-span-8 bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden flex flex-col min-h-[600px]">
                        <div id="no-selection" class="flex-1 flex flex-col items-center justify-center text-slate-300">
                            <i data-lucide="message-square" class="w-16 h-16 opacity-10 mb-4"></i>
                            <p class="font-black uppercase tracking-widest text-[10px]">Pilih laporan untuk diskusi</p>
                        </div>
                        <div id="chat-ui" class="hidden-section flex flex-col h-full">
                            <div id="chat-header" class="p-8 border-b bg-white flex justify-between items-center"></div>
                            <div id="chat-messages" class="flex-1 p-8 overflow-y-auto space-y-4 bg-slate-50/30"></div>
                            <div class="p-6 border-t bg-white flex gap-3">
                                <input type="text" id="chat-input" placeholder="Tulis balasan..." class="flex-1 bg-slate-50 p-4 rounded-xl outline-none text-sm font-bold">
                                <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 rounded-xl hover:bg-blue-700 transition-all"><i data-lucide="send" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-new" class="tab-content hidden-section max-w-2xl mx-auto">
                <h3 class="text-3xl font-black text-slate-900 mb-8">Buat Pengaduan Baru</h3>
                <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
                    <form id="new-complaint-form" class="space-y-6">
                        <input type="text" id="c-title" required placeholder="Apa masalahnya?" class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold focus:ring-2 focus:ring-blue-100 transition-all">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="c-phone" required placeholder="Nomor Telepon/WA" class="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold">
                            <input type="text" id="c-loc" required placeholder="Lokasi Kejadian" class="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold">
                        </div>
                        <textarea id="c-desc" required placeholder="Ceritakan kejadian selengkap mungkin..." class="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold h-32 focus:ring-2 focus:ring-blue-100 transition-all"></textarea>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                <span>Lampiran Foto (Maks 5)</span> <span id="img-counter">0/5</span>
                            </div>
                            <div id="preview-container" class="flex flex-wrap gap-2">
                                <label class="w-16 h-16 rounded-lg bg-slate-50 border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer text-slate-400">
                                    <i data-lucide="camera" class="w-5 h-5"></i>
                                    <input type="file" id="c-files" multiple accept="image/*" class="hidden" onchange="handleFiles(this)">
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-700 text-white font-black py-5 rounded-2xl uppercase text-xs tracking-widest shadow-xl">Kirim Laporan</button>
                    </form>
                </div>
            </div>

            <div id="tab-riwayat" class="tab-content hidden-section max-w-7xl mx-auto">
                <h3 class="text-3xl font-black text-slate-900 mb-10">Arsip Pengaduan</h3>
                <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA & AUTH ---
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: '123', fullName: 'Admin Ngaliyan', role: 'admin' },
            { username: 'warga', password: '123', fullName: 'Budi Santoso', role: 'warga' }
        ];
        let complaints = JSON.parse(localStorage.getItem('complaints')) || [];
        let currentUser = null;
        let currentChatId = null;
        let currentImages = [];

        function showForm(formType) {
            const login = document.getElementById('login-form');
            const admin = document.getElementById('admin-form');
            const reg = document.getElementById('register-form');
            const header = document.getElementById('auth-header');
            const subtitle = document.getElementById('auth-subtitle');

            [login, admin, reg].forEach(f => f.classList.add('hidden-section'));
            document.getElementById('auth-error').classList.add('hidden-section');

            if(formType === 'admin') {
                admin.classList.remove('hidden-section');
                header.classList.replace('from-blue-800', 'from-slate-900');
                header.classList.replace('to-emerald-700', 'to-slate-800');
                subtitle.innerText = "Akses Administrator";
            } else if(formType === 'register') {
                reg.classList.remove('hidden-section');
                header.classList.replace('from-blue-800', 'from-emerald-800');
                subtitle.innerText = "Registrasi Akun Baru";
            } else {
                login.classList.remove('hidden-section');
                header.classList.replace('from-slate-900', 'from-blue-800');
                header.classList.replace('to-slate-800', 'to-emerald-700');
                subtitle.innerText = "Portal Pengaduan Warga";
            }
            lucide.createIcons();
        }

        // Handle Logins
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('l-user').value;
            const p = document.getElementById('l-pass').value;
            authenticate(u, p, 'warga');
        };

        document.getElementById('admin-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            authenticate(u, p, 'admin');
        };

        function authenticate(username, password, expectedRole) {
            const user = users.find(u => u.username === username && u.password === password);
            if(user) {
                if(expectedRole === 'admin' && user.role !== 'admin') {
                    showError("Anda tidak memiliki akses Admin!");
                    return;
                }
                currentUser = user;
                enterApp();
            } else {
                showError("Username atau Password salah!");
            }
        }

        function showError(m) {
            document.getElementById('auth-error').classList.remove('hidden-section');
            document.getElementById('error-msg').innerText = m;
        }

        function enterApp() {
            document.getElementById('auth-screen').classList.add('hidden-section');
            document.getElementById('main-app').classList.remove('hidden-section');
            document.getElementById('user-fullname').innerText = currentUser.fullName;
            document.getElementById('user-role-label').innerText = currentUser.role;
            if(currentUser.role === 'warga') document.getElementById('nav-new').classList.remove('hidden');
            renderComplaintList();
            lucide.createIcons();
        }

        // Registration
        document.getElementById('register-form').onsubmit = (e) => {
            e.preventDefault();
            const newUser = {
                username: document.getElementById('r-user').value,
                password: document.getElementById('r-pass').value,
                fullName: document.getElementById('r-name').value,
                role: 'warga'
            };
            if(users.find(u => u.username === newUser.username)) return showError("Username sudah terpakai!");
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            alert("Akun Berhasil Dibuat!");
            showForm('login');
        };

        // --- CORE FEATURES (FITUR SEBELUMNYA) ---
        function changeTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
            document.getElementById('tab-' + tab).classList.remove('hidden-section');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-50', 'text-blue-700');
                b.classList.add('text-slate-400');
            });
            document.getElementById('nav-' + tab).classList.add('bg-blue-50', 'text-blue-700');
            if(tab === 'riwayat') renderHistory();
            if(tab === 'dashboard') renderComplaintList();
            lucide.createIcons();
        }

        function renderComplaintList() {
            const list = document.getElementById('complaint-list');
            const data = currentUser.role === 'admin' ? complaints : complaints.filter(c => c.username === currentUser.username);
            list.innerHTML = data.map(c => `
                <div onclick="openDetail(${c.id})" class="p-6 rounded-[2rem] bg-white border border-slate-100 hover:border-blue-300 cursor-pointer shadow-sm transition-all">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[9px] font-black px-2 py-1 bg-blue-50 text-blue-700 rounded-lg uppercase">${c.status}</span>
                        <span class="text-[10px] text-slate-300 font-bold">${c.date}</span>
                    </div>
                    <h4 class="font-bold text-slate-800">${c.title}</h4>
                    <p class="text-[10px] text-slate-400 mt-2 font-black uppercase tracking-tighter"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${c.location}</p>
                </div>
            `).join('') || '<p class="text-center py-10 text-slate-300 font-bold italic">Tidak ada laporan</p>';
            lucide.createIcons();
        }

        function openDetail(id) {
            currentChatId = id;
            const comp = complaints.find(c => c.id === id);
            document.getElementById('no-selection').classList.add('hidden-section');
            document.getElementById('chat-ui').classList.remove('hidden-section');
            document.getElementById('chat-header').innerHTML = `
                <div>
                    <h4 class="font-black text-slate-900 text-xl">${comp.title}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pelapor: ${comp.fullName} | Lokasi: ${comp.location}</p>
                </div>
                ${currentUser.role === 'admin' ? `<button onclick="closeTicket(${id})" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Selesaikan</button>` : ''}
            `;
            renderMessages();
        }

        function renderMessages() {
            const comp = complaints.find(c => c.id === currentChatId);
            const box = document.getElementById('chat-messages');
            box.innerHTML = comp.chats.map(m => `
                <div class="flex ${m.user === currentUser.username ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] p-4 rounded-2xl text-sm font-bold shadow-sm ${m.user === currentUser.username ? 'bg-slate-900 text-white' : 'bg-white text-slate-700 border border-slate-100'}">
                        <p class="text-[8px] opacity-40 uppercase mb-1">${m.sender}</p>
                        ${m.text}
                    </div>
                </div>
            `).join('');
            box.scrollTop = box.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if(!input.value.trim() || !currentChatId) return;
            const comp = complaints.find(c => c.id === currentChatId);
            comp.chats.push({ user: currentUser.username, sender: currentUser.fullName, text: input.value });
            localStorage.setItem('complaints', JSON.stringify(complaints));
            input.value = ''; renderMessages();
        }

        function closeTicket(id) {
            complaints.find(c => c.id === id).status = 'Selesai';
            localStorage.setItem('complaints', JSON.stringify(complaints));
            openDetail(id);
        }

        // Files
        function handleFiles(input) {
            const files = Array.from(input.files);
            if(currentImages.length + files.length > 5) return alert("Maksimal 5 foto!");
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => { currentImages.push(e.target.result); renderPreviews(); };
                reader.readAsDataURL(file);
            });
        }

        function renderPreviews() {
            const cont = document.getElementById('preview-container');
            document.getElementById('img-counter').innerText = `${currentImages.length}/5`;
            cont.querySelectorAll('.p-item').forEach(e => e.remove());
            currentImages.forEach((img, i) => {
                const d = document.createElement('div');
                d.className = "p-item w-16 h-16 rounded-lg relative overflow-hidden border";
                d.innerHTML = `<img src="${img}" class="w-full h-full object-cover"><button onclick="removeImg(${i})" class="absolute top-0 right-0 bg-rose-500 text-white p-0.5 rounded-bl-lg text-[10px]">Ã—</button>`;
                cont.appendChild(d);
            });
        }
        function removeImg(i) { currentImages.splice(i,1); renderPreviews(); }

        document.getElementById('new-complaint-form').onsubmit = (e) => {
            e.preventDefault();
            complaints.unshift({
                id: Date.now(),
                username: currentUser.username,
                fullName: currentUser.fullName,
                title: document.getElementById('c-title').value,
                phone: document.getElementById('c-phone').value,
                location: document.getElementById('c-loc').value,
                description: document.getElementById('c-desc').value,
                status: 'Menunggu',
                date: new Date().toLocaleDateString('id-ID'),
                images: [...currentImages],
                chats: []
            });
            localStorage.setItem('complaints', JSON.stringify(complaints));
            currentImages = []; e.target.reset(); renderPreviews();
            alert('Laporan Terkirim!'); changeTab('dashboard');
        };

        function renderHistory() {
            const grid = document.getElementById('history-grid');
            const data = currentUser.role === 'admin' ? complaints : complaints.filter(c => c.username === currentUser.username);
            grid.innerHTML = data.map(c => `
                <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="flex gap-2 mb-4">${c.images.map(img => `<img src="${img}" class="w-12 h-12 rounded-lg object-cover border">`).join('')}</div>
                    <h4 class="font-black text-xl text-slate-800 mb-2">${c.title}</h4>
                    <p class="text-xs text-slate-400 font-bold mb-6 line-clamp-2 italic leading-relaxed">"${c.description}"</p>
                    <div class="grid grid-cols-2 gap-2 text-[10px] font-black text-slate-500 uppercase tracking-widest mb-6">
                        <span><i data-lucide="phone" class="w-3 h-3 inline"></i> ${c.phone}</span>
                        <span><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${c.location}</span>
                    </div>
                    <button onclick="openLiveChat(${c.id})" class="w-full flex items-center justify-center gap-2 py-4 bg-emerald-600 text-white rounded-2xl text-xs font-black uppercase hover:bg-emerald-700 transition-all shadow-lg">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> Live Chat Sekarang
                    </button>
                </div>
            `).join('') || '<p class="text-center col-span-2 py-20 text-slate-300 font-black uppercase tracking-widest">Kosong</p>';
            lucide.createIcons();
        }

        function openLiveChat(id) { changeTab('dashboard'); openDetail(id); }

        lucide.createIcons();
    </script>
</body>
</html>
